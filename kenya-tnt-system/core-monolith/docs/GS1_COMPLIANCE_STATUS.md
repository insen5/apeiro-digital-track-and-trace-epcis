# GS1 Compliance Status

This document tracks the GS1 compliance status of all implemented identifiers in the Kenya TNT System.

**Last Updated**: 2025-01-XX

---

## Compliance Summary

| Identifier | Company Prefix | Check Digit | Structure | Validation | Status |
|------------|---------------|-------------|-----------|------------|--------|
| **SSCC** | ✅ Yes (6-12 digits) | ✅ Yes (correct algorithm) | ✅ Correct | ✅ Full | ✅ **Fully Compliant** |
| **GLN** | ✅ Yes (6-12 digits) | ✅ Yes (correct algorithm) | ✅ Correct | ✅ Full | ✅ **Fully Compliant** |
| **GTIN** | ⚠️ N/A (external source) | ✅ Yes (all formats) | ✅ Correct | ✅ Full | ✅ **Fully Compliant** |
| **SGTIN** | ✅ Yes (variable 6-12) | ✅ Yes (via GTIN) | ✅ Correct | ✅ Full | ✅ **Fully Compliant** |
| **Batch/Lot** | ⚠️ No (flexible format) | ❌ N/A | ⚠️ Custom | ✅ Basic | ⚠️ **Acceptable** |

---

## Detailed Compliance Analysis

### ✅ 1. SSCC (Serial Shipping Container Code)

**Status**: ✅ **Fully GS1 Compliant**

**Implementation Details**:
- **Company Prefix**: ✅ Uses GS1 Company Prefix (6-12 digits) from organization
- **Check Digit Algorithm**: ✅ Correct (odd positions × 3, even × 1 from right)
- **Structure**: ✅ Extension (1) + Prefix + Serial Reference + Check Digit = 18 digits
- **Validation**: ✅ Full validation including check digit verification
- **Generation**: ✅ Automatically uses organization's GS1 prefix when available
- **Location**: `src/shared/gs1/sscc.service.ts`

**Example**:
- Prefix: `61640040` (8 digits)
- Extension: `0`
- Serial Reference: `12345678` (8 digits)
- Check Digit: Calculated
- Result: `06164004012345678X` (18 digits)

**Notes**:
- Has fallback without prefix (warns, for backward compatibility)
- Uniqueness checked across Shipment, Package, and Case tables

---

### ✅ 2. GLN (Global Location Number)

**Status**: ✅ **Fully GS1 Compliant**

**Implementation Details**:
- **Company Prefix**: ✅ Uses GS1 Company Prefix (6-12 digits) from organization
- **Check Digit Algorithm**: ✅ Correct (odd positions × 1, even × 3 from right)
- **Structure**: ✅ Prefix + Location Reference + Check Digit = 13 digits
- **Validation**: ✅ Full validation including check digit verification
- **Generation**: ✅ Can generate HQ GLN and location-specific GLNs
- **Location**: `src/shared/gs1/gln.service.ts`

**Example**:
- Prefix: `61640040` (8 digits)
- Location Ref: `0000` (4 digits for HQ)
- Check Digit: Calculated
- Result: `6164004000007` (13 digits)

**Notes**:
- Seed data updated with correct check digits
- Supports variable prefix lengths (6-12 digits)

---

### ✅ 3. GTIN (Global Trade Item Number)

**Status**: ✅ **Fully GS1 Compliant** (Validation Only)

**Implementation Details**:
- **Company Prefix**: ⚠️ N/A (GTINs come from external source/PPB catalog)
- **Check Digit Algorithm**: ✅ Correct for all formats:
  - GTIN-8, GTIN-12, GTIN-13: odd positions × 1, even × 3 (from right)
  - GTIN-14: odd positions × 3, even × 1 (from right)
- **Structure**: ✅ Supports 8, 12, 13, and 14 digit formats
- **Validation**: ✅ Full validation including check digit verification
- **Generation**: ❌ Not generated (GTINs assigned by GS1/PPB)
- **Location**: `src/shared/gs1/sgtin.service.ts`

**Example**:
- GTIN-13: `5901234123457` ✅ Valid
- GTIN-14: `10123456789012` ✅ Valid

**Notes**:
- GTINs are typically assigned by GS1, not generated by the system
- System validates GTINs received from PPB catalog or external sources
- Check digit validation now fully implemented

---

### ✅ 4. SGTIN (Serialized Global Trade Item Number)

**Status**: ✅ **Fully GS1 Compliant**

**Implementation Details**:
- **Company Prefix**: ✅ Uses variable prefix length (6-12 digits)
- **Check Digit**: ✅ Validated via GTIN check digit
- **Structure**: ✅ `urn:epc:id:sgtin:CompanyPrefix.ItemRef.SerialNumber`
- **Validation**: ✅ Full validation including prefix length, item ref, serial number
- **Generation**: ✅ Properly extracts prefix from GTIN when company prefix provided
- **Location**: `src/shared/gs1/sgtin.service.ts`

**Example**:
- GTIN: `061640040123456` (GTIN-14)
- Company Prefix: `61640040` (8 digits)
- Item Ref: `123456` (6 digits)
- Serial Number: `SN123456`
- Result: `urn:epc:id:sgtin:61640040.123456.SN123456`

**Notes**:
- **Fixed**: Previously hardcoded 7-digit prefix assumption
- **Fixed**: Now properly handles variable prefix lengths (6-12 digits)
- **Fixed**: GTIN check digit validation implemented
- **Recommendation**: Always provide `companyPrefix` in DTO for accurate SGTIN generation

---

### ⚠️ 5. Batch/Lot Number

**Status**: ⚠️ **Acceptable** (GS1 Allows Flexible Format)

**Implementation Details**:
- **Company Prefix**: ❌ Not included (custom format)
- **Check Digit**: ❌ N/A (batch numbers don't require check digits)
- **Structure**: ⚠️ Custom format: `BATCH-YYYYMMDD-RANDOM`
- **Validation**: ✅ Basic alphanumeric validation
- **Generation**: ✅ Unique per product and user
- **Location**: `src/shared/gs1/batch-number.service.ts`

**Current Format**:
```
BATCH-20241219-ABC123
```

**GS1 Standard**:
- Batch/Lot numbers are **alphanumeric strings** assigned by the company
- **No standard numeric format** or check digit required
- Format is flexible but should be consistent
- Should be unique per product/manufacturer

**Recommendations**:
1. ✅ Current format is acceptable (GS1 allows flexible batch formats)
2. ⚠️ Consider adding company prefix for global uniqueness: `{PREFIX}-BATCH-YYYYMMDD-RANDOM`
3. ⚠️ Consider using GS1 Application Identifier (AI) 10 for batch numbers in barcodes

**Example Enhanced Format** (Optional):
```
61640040-BATCH-20241219-ABC123
```

---

## Check Digit Algorithms

### SSCC Check Digit
- **Algorithm**: Odd positions (from right) × 3, Even positions × 1
- **Base Length**: 17 digits
- **Example**: `06164004012345678` → Check digit calculated

### GLN Check Digit
- **Algorithm**: Odd positions (from right) × 1, Even positions × 3
- **Base Length**: 12 digits
- **Example**: `616400400000` → Check digit: `7`

### GTIN Check Digit
- **GTIN-8, GTIN-12, GTIN-13**: Odd positions (from right) × 1, Even positions × 3
- **GTIN-14**: Odd positions (from right) × 3, Even positions × 1
- **Base Length**: 7, 11, 12, or 13 digits (depending on format)
- **Example**: `590123412345` (GTIN-13 base) → Check digit: `7`

---

## Company Prefix Usage

### How Company Prefixes Are Retrieved

1. **User Context**: System looks up user's `organization` field
2. **Master Data Lookup**: Finds supplier/manufacturer by `entity_id`
3. **Prefix Retrieval**: Gets `gs1Prefix` from supplier/manufacturer record
4. **Identifier Generation**: Uses prefix in SSCC/GLN generation

### Current Prefixes in Seed Data

- **Suppliers**: `73510020`, `61640010`, `61640020`, `61640030`
- **Manufacturers**: `61640040`, `61640050`, `61640060`, `61640070`
- **Logistics Providers**: `61640080`, `61640090`, `61640100`

All prefixes are 8 digits (valid GS1 Company Prefix length).

---

## Validation Coverage

### ✅ Fully Validated
- SSCC: Format, length, check digit, uniqueness
- GLN: Format, length, check digit
- GTIN: Format, length, check digit (all formats)
- SGTIN: Format, prefix length, item ref length, serial number

### ⚠️ Basic Validation
- Batch/Lot: Format (alphanumeric), non-empty

---

## Recommendations

### Immediate Actions (Completed)
1. ✅ Implement GTIN check digit validation
2. ✅ Fix SGTIN prefix extraction (variable length)
3. ✅ Update SSCC generation to use company prefixes
4. ✅ Update GLN generation with proper check digits

### Future Enhancements
1. ⚠️ Consider adding company prefix to batch numbers for global uniqueness
2. ⚠️ Add GTIN generation capability (if needed, though typically assigned by GS1)
3. ⚠️ Implement GRAI and GDTI services (see backlog)

---

## Testing

All identifiers can be tested via demo endpoints:
- `GET /api/demo/gs1/sscc` - Generate SSCC
- `GET /api/demo/gs1/sgtin` - Generate SGTIN
- `GET /api/demo/gs1/batch` - Generate Batch Number

**Note**: Demo endpoints may not use company prefixes. In production, all identifiers use organization's GS1 prefix automatically.

---

## Compliance Checklist

- [x] SSCC uses GS1 Company Prefix
- [x] SSCC check digit calculation correct
- [x] GLN uses GS1 Company Prefix
- [x] GLN check digit calculation correct
- [x] GTIN check digit validation implemented
- [x] SGTIN uses variable prefix length
- [x] SGTIN properly extracts prefix from GTIN
- [x] All identifiers validate check digits
- [x] Seed data has correct check digits
- [x] Company prefixes retrieved from master data

---

## References

- [GS1 General Specifications](https://www.gs1.org/standards/genspecs)
- [GS1 Check Digit Calculator](https://www.gs1.org/services/check-digit-calculator)
- [EPCIS 2.0 Standard](https://www.gs1.org/standards/epcis)

