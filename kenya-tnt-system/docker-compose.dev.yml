version: '3.8'

# Development overrides for hot reload and faster iteration
# Usage: docker compose -f docker-compose.production.yml -f docker-compose.dev.yml up

services:
  # ============================================
  # BACKEND - Development Mode with Hot Reload
  # ============================================
  backend:
    build:
      context: ./core-monolith
      dockerfile: Dockerfile.dev
    volumes:
      # Mount source code for hot reload
      - ./core-monolith/src:/app/src:delegated
      - ./core-monolith/database:/app/database:delegated
      - ./core-monolith/tsconfig.json:/app/tsconfig.json:ro
      - ./core-monolith/tsconfig.build.json:/app/tsconfig.build.json:ro
      - ./core-monolith/nest-cli.json:/app/nest-cli.json:ro
      # Use named volume ONLY for node_modules (dist/ stays ephemeral in container)
      - backend-node-modules:/app/node_modules
    environment:
      NODE_ENV: development
      LOG_LEVEL: debug
      # Database connection (must match production.yml service name)
      DB_HOST: postgres
      DB_PORT: 5432
      DB_USERNAME: ${POSTGRES_USER:-tnt_user}
      DB_PASSWORD: ${POSTGRES_PASSWORD:-tnt_password}
      DB_DATABASE: ${POSTGRES_DB:-kenya_tnt_db}
      PORT: 4000
      JWT_SECRET: ${JWT_SECRET}
      JWT_EXPIRES_IN: 7d
      CORS_ORIGIN: "*"
      # Kafka connection (use service name, not localhost)
      KAFKA_BROKER: kafka:9092
    # Override health check for dev (faster, more forgiving)
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:4000/api/health || exit 1"]
      interval: 60s
      timeout: 10s
      start_period: 120s
      retries: 3

  # ============================================
  # FRONTEND - Development Mode with Hot Reload
  # ============================================
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.dev
    volumes:
      # Mount source code for hot reload
      - ./frontend/app:/app/app:delegated
      - ./frontend/components:/app/components:delegated
      - ./frontend/lib:/app/lib:delegated
      - ./frontend/public:/app/public:delegated
      - ./frontend/next.config.ts:/app/next.config.ts:ro
      - ./frontend/tsconfig.json:/app/tsconfig.json:ro
      - ./frontend/postcss.config.mjs:/app/postcss.config.mjs:ro
      - ./frontend/eslint.config.mjs:/app/eslint.config.mjs:ro
      # Prevent overwriting
      - /app/node_modules
      - /app/.next
    environment:
      NODE_ENV: development
      NEXT_TELEMETRY_DISABLED: 1
      NEXT_PUBLIC_API_BASE_URL: http://localhost:4000/api

# Named volumes for development (node_modules only)
volumes:
  backend-node-modules:

# Note: Infrastructure services (postgres, kafka, opensearch, etc.) 
# inherit from docker-compose.production.yml without changes



